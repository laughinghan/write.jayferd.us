<div class="highlight"><pre><span class="k">module</span> <span class="nn">Colorize</span>
  <span class="k">def</span> <span class="nf">colorize</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="n">doc</span> <span class="o">=</span> <span class="no">Hpricot</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="n">doc</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s1">&#39;pre&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">each</span> <span class="k">do</span> <span class="o">|</span><span class="n">pre</span><span class="o">|</span>
      <span class="n">code</span> <span class="o">=</span> <span class="n">pre</span><span class="o">.</span><span class="n">children</span><span class="o">[</span><span class="mi">0</span><span class="o">].</span><span class="n">inner_text</span>

      <span class="n">lang</span><span class="p">,</span> <span class="n">code</span> <span class="o">=</span> <span class="n">parse_lang</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>

      <span class="n">colorized</span> <span class="o">=</span> <span class="n">pygments_api</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">lang</span><span class="p">)</span>

      <span class="n">pre</span><span class="o">.</span><span class="n">swap</span><span class="p">(</span><span class="n">colorized</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="n">doc</span><span class="o">.</span><span class="n">to_html</span>
  <span class="k">end</span>

  <span class="no">PYGMENTS_API</span> <span class="o">=</span> <span class="s1">&#39;http://pygments.appspot.com/&#39;</span>

  <span class="k">def</span> <span class="nf">pygments_api</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">lang</span><span class="o">=</span><span class="kp">nil</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">&lt;&lt;-</span><span class="no">html</span> <span class="k">unless</span> <span class="n">lang</span>
<span class="sh">      &lt;div class=&quot;highlight&quot;&gt;&lt;pre&gt;#{code}&lt;/pre&gt;&lt;/div&gt;</span>
<span class="no">    html</span>

    <span class="no">HTTParty</span><span class="o">.</span><span class="n">post</span><span class="p">(</span><span class="no">PYGMENTS_API</span><span class="p">,</span> <span class="ss">:body</span> <span class="o">=&gt;</span> <span class="p">{</span>
      <span class="ss">:code</span> <span class="o">=&gt;</span> <span class="n">code</span><span class="p">,</span>
      <span class="ss">:lang</span> <span class="o">=&gt;</span> <span class="n">lang</span>
    <span class="p">})</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">parse_lang</span><span class="p">(</span><span class="n">code</span><span class="p">)</span>
    <span class="k">return</span> <span class="o">[</span><span class="kp">nil</span><span class="p">,</span> <span class="n">code</span><span class="o">]</span> <span class="k">unless</span> <span class="n">code</span><span class="o">.</span><span class="n">start_with?</span> <span class="s1">&#39;@@&#39;</span>

    <span class="n">lines</span> <span class="o">=</span> <span class="n">code</span><span class="o">.</span><span class="n">split</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">lines</span><span class="o">.</span><span class="n">shift</span> <span class="o">=~</span> <span class="sr">/@@\s*(\w+)/</span>

    <span class="o">[</span><span class="ss">:&quot;</span><span class="si">#{</span><span class="vg">$1</span><span class="si">}</span><span class="ss">&quot;</span><span class="p">,</span> <span class="n">lines</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span><span class="o">]</span>
  <span class="k">end</span>
<span class="k">end</span>
</pre></div>
